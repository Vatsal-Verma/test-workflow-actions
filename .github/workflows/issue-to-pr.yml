name: Create PR from Story Issue

on:
  issues:
    types: [opened]

jobs:
  convert-to-pr:
    if: contains(github.event.issue.labels.*.name, 'story-submission')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Create branch and JSON
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          BRANCH="story-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"

          node <<'EOF'
          const fs = require('fs');

          const data = {
            issue_number: process.env.ISSUE_NUMBER,
            title: process.env.ISSUE_TITLE,
            body: process.env.ISSUE_BODY
          };

          fs.writeFileSync(
            `story-${process.env.ISSUE_NUMBER}.json`,
            JSON.stringify(data, null, 2)
          );
          EOF

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Add story from issue #${ISSUE_NUMBER}"
          git push origin "$BRANCH"

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create Pull Request
        run: |
          gh pr create             --title "Story: ${{ github.event.issue.title }}"             --body "Auto-generated from issue #${{ github.event.issue.number }}"             --base main             --head story-${{ github.event.issue.number }}
